name: Test ScanCode Output

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install ScanCode Toolkit
        run: |
          set -eux  # fail fast (-e), print commands (-x), treat unset vars as error (-u)
          git clone https://github.com/nexB/scancode-toolkit.git
          cd scancode-toolkit
          ./configure

      - name: ğŸš€ Run ScanCode
        run: |
          set -eux
          ./scancode-toolkit/scancode -clpeui \
            --json-pp scan-output.json \
            src/lodash

      - name: ğŸ“„ Show last 20 lines of scan-output.json
        run: |
         set -eux
         ls -l scan-output.json
         tail -n 20 scan-output.json

      - name: ğŸ“œ Show detected licenses
        run: |
          echo "Detected licenses:"
          jq -r '.. | .license_expression? // empty' scan-output.json | sort -u

     # - name: ğŸ” Inspect first file object
     #   run: |
     #    jq '.files[0]' scan-output.json

      - name: ğŸ“œ Show licenses grouped by files
        run: |
          echo -e "\033[1;34mğŸ“Š Licenses and associated files:\033[0m"
          jq '
            .files[]
            | select(.detected_license_expression != null and .detected_license_expression != "")
            | {license: .detected_license_expression, file: .path}
          ' scan-output.json \
          | jq -s -r '
              group_by(.license)[] |
              "License: \033[1;32m\(.0.license)\033[0m\n" +
              (map(.file) | unique | sort | map("  - " + .) | join("\n")) +
              "\n"
            '





    

          
