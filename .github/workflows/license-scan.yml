name: FOSS License Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  scancode:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # 1. Checkout repository
      # --------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2. Run ScanCode (official, prebuilt, CI-safe)
      # --------------------------------------------------
      - name: ðŸ” Run ScanCode license scan
        uses: aboutcode-org/scancode-action@beta
        with:
          pipelines: scan_codebase
          output-formats: json
          output-file: scan-output.json

      # --------------------------------------------------
      # 3. Show detected licenses (unique list)
      # --------------------------------------------------
      - name: ðŸ“œ Detected license expressions (summary)
        run: |
          echo "===== Detected Licenses ====="
          jq -r '
            .files[]
            | (.detected_license_expression_spdx
               // .detected_license_expression
               // empty)
          ' scan-output.json \
          | sort -u

      # --------------------------------------------------
      # 4. Highlight licenses per file (grouped)
      # --------------------------------------------------
      - name: ðŸ“Š Licenses grouped by files
        run: |
          echo "===== Licenses and Files ====="
          jq '
            .files[]
            | select(.detected_license_expression != null and .detected_license_expression != "")
            | { license: .detected_license_expression, file: .path }
          ' scan-output.json \
          | jq -s '
              group_by(.license)[] |
              {
                license: .[0].license,
                files: (map(.file) | unique | sort)
              }
            ' \
          | jq -r '
              "License: " + .license + "\n"
              + (.files | map("  - " + .) | join("\n"))
              + "\n"
            '

      # --------------------------------------------------
      # 5. Highlight risky licenses (NO FAIL, only warning)
      # --------------------------------------------------
      - name: âš ï¸ Highlight risky licenses (GPL / AGPL)
        run: |
          echo "===== Risky License Check ====="
          jq -r '
            .files[]
            | select(.detected_license_expression != null)
            | select(.detected_license_expression
                     | test("GPL|AGPL|SSPL"; "i"))
            | "âš ï¸  " + .path + "  ->  " + .detected_license_expression
          ' scan-output.json || true

      # --------------------------------------------------
      # 6. Upload ScanCode report (artifact)
      # --------------------------------------------------
      - name: ðŸ“¦ Upload ScanCode report
        uses: actions/upload-artifact@v4
        with:
          name: scancode-license-report
          path: scan-output.json
