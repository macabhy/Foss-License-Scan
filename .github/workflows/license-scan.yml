name: Test ScanCode Output

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üì¶ Install ScanCode Toolkit
        run: |
          set -eux  # fail fast (-e), print commands (-x), treat unset vars as error (-u)
          git clone https://github.com/nexB/scancode-toolkit.git
          cd scancode-toolkit
          ./configure

      - name: üöÄ Run ScanCode
        run: |
          set -eux
          ./scancode-toolkit/scancode -clpeui \
            --json-pp scan-output.json \
            src/lodash

      - name: ‚ùå Fail if exclusive GPL/AGPL license detected
        run: |
          set -eux
          # Define GPL/AGPL licenses (lowercase for safety)
          GPL_LICENSES=(
            "gpl-2.0-only"
            "gpl-2.0-or-later"
            "gpl-3.0-only"
            "gpl-3.0-or-later"
            "agpl-3.0-only"
            "agpl-3.0-or-later"
          )

          # Function to lowercase a string
          strtolower() {
            echo "$1" | tr '[:upper:]' '[:lower:]'
          }

          # Extract all license expressions from files (detected_license_expression)
          mapfile -t licenses < <(jq -r '.files[].detected_license_expression // empty' scan-output.json)

          for expr in "${licenses[@]}"; do
            # Remove spaces for safety
            expr_nospace=$(echo "$expr" | tr -d ' ')

            # Count number of licenses separated by AND/OR
            # We split by "AND" or "OR" ignoring case
            IFS=$'\n' read -rd '' -a parts < <(echo "$expr" | grep -oiE '[^ ]+' | tr '[:upper:]' '[:lower:]' | grep -v -E 'and|or' || true)
            
            # Number of licenses is length of parts
            count=${#parts[@]}
            
            # If single license expression
            if [ "$count" -eq 1 ]; then
              lic_lower=$(strtolower "${parts[0]}")

              # Check if in GPL list
              for gpl_lic in "${GPL_LICENSES[@]}"; do
                if [ "$lic_lower" = "$gpl_lic" ]; then
                  echo "ERROR: File licensed exclusively under GPL/AGPL: $expr"
                  exit 1
                fi
              done
            else
              # Multi-licensed: do nothing (allow build)
              echo "INFO: Multi-licensed file, skipping fail: $expr"
            fi
          done
      

      - name: üìÑ Show last 20 lines of scan-output.json
        run: |
         set -eux
         ls -l scan-output.json
         tail -n 20 scan-output.json

      - name: üìú Show detected licenses
        run: |
          echo "Detected licenses:"
          jq -r '.. | .license_expression? // empty' scan-output.json | sort -u

     # - name: üîç Inspect first file object
     #   run: |
     #    jq '.files[0]' scan-output.json

      - name: üìú Show licenses grouped by files
        run: |
          BLUE='\033[1;34m'
          GREEN='\033[1;32m'
          RESET='\033[0m'

          echo -e "${BLUE}üìä Licenses and associated files:${RESET}"
          jq '
            .files[]
            | select(.detected_license_expression != null and .detected_license_expression != "")
            | {license: .detected_license_expression, file: .path}
          ' scan-output.json \
          | jq -s -r '
              group_by(.license)[] |
              "License: " + .[0].license + "\n" +
              (map(.file) | unique | sort | map("  - " + .) | join("\n")) +
              "\n"
            ' \
          | while IFS= read -r line; do
              if [[ "$line" == License:* ]]; then
                echo -e "License: ${GREEN}${line#License: }${RESET}"
              else
                echo "$line"
              fi
            done






    

          
